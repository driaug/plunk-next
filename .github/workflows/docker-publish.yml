name: Docker Publish (Main Branch)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  compute-tags:
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.compute.outputs.tags }}
    steps:
      - name: Compute tags for main branch
        id: compute
        run: |
          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA:0:7}"
          TAGS="sha-${SHORT_SHA},latest"
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "Computed tags: $TAGS"

  build:
    needs: compute-tags
    uses: ./.github/workflows/docker-build.yml
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    with:
      tags: ${{ needs.compute-tags.outputs.tags }}
      ref: ${{ github.ref_name }}
