name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  packages: write
  attestations: write
  id-token: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      tag_name: ${{ steps.tag.outputs.tag_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get created tag
        id: tag
        if: ${{ steps.release.outputs.releases_created }}
        run: |
          git fetch --tags
          LATEST_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n1)
          echo "tag_name=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Created tag: $LATEST_TAG"

  compute-tags:
    needs: release-please
    if: ${{ needs.release-please.outputs.releases_created }}
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.compute.outputs.tags }}
    steps:
      - name: Compute semver tags
        id: compute
        run: |
          TAG_NAME="${{ needs.release-please.outputs.tag_name }}"
          VERSION="${TAG_NAME#v}"
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          TAGS="${VERSION},${MAJOR}.${MINOR},${MAJOR},latest"
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "Computed tags: $TAGS"

  build:
    needs: [release-please, compute-tags]
    if: ${{ needs.release-please.outputs.releases_created }}
    uses: ./.github/workflows/docker-build.yml
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    with:
      tags: ${{ needs.compute-tags.outputs.tags }}
      ref: ${{ needs.release-please.outputs.tag_name }}
